# åº•å±‚åŸç†ç¯‡
æœ¬ç¯‡æ‰“ç®—ä»¥è¾¹è¯´æ¦‚å¿µè¾¹è§£é—®é¢˜çš„æ–¹å¼æ·±å…¥æ¢è®¨iOSåº•å±‚ä¸€äº›é€»è¾‘é—®é¢˜,æœ‰ä»»ä½•é—®é¢˜æ¬¢è¿[issue](https://github.com/binzi56/iOSSmallKnowledgePool/issues);

### `@autoreleasepool`ä¸`autorelease`
åœ¨å¼€å‘ä¸­ç»å¸¸ç”¨`@autoreleasepool`æ¥è§£å†³`autorelease`äº§ç”Ÿçš„å†…å­˜é—®é¢˜;
ä¸¾ä¸ªğŸŒ°:
```
for (NSInteger i = 0; i < 10000000; i++) {
    @autoreleasepool {
        NSString *tempStr = [NSString stringWithFormat:@"ä¸´æ—¶å˜é‡"];
    }
}
```

ç®€è¿°
ç›®å‰åŒºåˆ†æ˜¯å¦ä½¿ç”¨äº†`autorelease`æŒ‰ä»¥ä¸‹è§„å¾‹:
> 1. ä½¿ç”¨alloc/new/copy/mutableCopy/init åˆ›å»ºä¸´æ—¶å¯¹è±¡ç›´æ¥è¿”å›è¢«retainå¯¹è±¡ï¼Œä¸ä¼šè¿›å…¥autoreleasepoolä¸­;(å…·ä½“çœ‹[ARCè§„å®š](https://clang.llvm.org/docs/AutomaticReferenceCounting.html#precise-lifetime-semantics), å®é™…ä½¿ç”¨ä¸Šå¸¸è§äºä¸€äº›å¯¹è±¡çš„æ„é€ æ–¹æ³•å³ç±»æ–¹æ³•)
> 2. ä½¿ç”¨å…¶å®ƒæ–¹æ³•åˆ›å»ºçš„ä¸´æ—¶å¯¹è±¡åˆ™ä¼šè‡ªåŠ¨å°†è¿”å›çš„å¯¹è±¡æ³¨å†Œåˆ°æ± å­ä¸­(æ³¨æ„:è¿™é‡Œæ˜¯è‡ªå·±ä¸æŒæœ‰çš„å¯¹è±¡);

å†é™„ä¸€ä¸ª`NSAutoreleasepool`çš„ç”Ÿå‘½å‘¨æœŸä»¥ä¾›è§‚èµ:
![NSAutoreleasepoolçš„ç”Ÿå‘½å‘¨æœŸ](https://upload-images.jianshu.io/upload_images/1893416-68279ed8c41752b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

Q1:`autorelease`å› ä½•å­˜åœ¨?
åœ¨OCçš„å†…å­˜ç®¡ç†æœºåˆ¶ä¸­æœ‰ä¸€æ¡è§„å¾‹æ˜¯ï¼šè°ç”³è¯·ï¼Œè°é‡Šæ”¾;
é‚£ä¹ˆå¦‚æœéœ€è¦å»¶é•¿ç”Ÿå‘½å‘¨æœŸæˆ–è€…æŸä¸ªæ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ªæ–°å»ºå¯¹è±¡å¹¶åœ¨åˆé€‚çš„æ—¶æœºæ¥é‡Šæ”¾,æ­¤æ—¶å°±éœ€è¦`autorelease`æ¥åº”å¯¹è¿™äº›æƒ…å†µ,è¿™æ ·æ—¢èƒ½ç¡®ä¿å¯¹è±¡èƒ½æ­£ç¡®é‡Šæ”¾ï¼Œåˆèƒ½è¿”å›æœ‰æ•ˆçš„å¯¹è±¡ã€‚

Q2:`autorelease`å’Œ`@autoreleasepool`å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„?
è¿™é‡Œç”¨[GNUstepæºç ](http://www.gnustep.org/resources/downloads.php)æ¥è§£é‡Š;
```
//autorelease
- (id)autorelease
{
    [NSAutoreleasePool addObject:self];
}
```

```
//@autoreleasepool
+ (void)addobject:(id)anObj{
    NSAutoreleasePool *pool = å–å¾—æ­£åœ¨ä½¿ç”¨çš„NSAutoreleasePoolå¯¹è±¡;
    if (pool != nil){
        [pool addobject:an0bj];
    }else{
        NSLog ( @"NSAutoreleasePoolå¯¹è±¡éå­˜åœ¨çŠ¶æ€ä¸‹è°ƒç”¨autorelease");
    }
}

- (void)addObject:(id)anObj
{
    [pool.array addObject:anObj];
}
```
`autorelease`å®ä¾‹æ–¹æ³•çš„æœ¬è´¨å°±æ˜¯è°ƒç”¨`NSAutoreleasePool`å¯¹è±¡çš„`addObject:`ç±»æ–¹æ³•ï¼Œç„¶åè¿™ä¸ªå¯¹è±¡å°±è¢«è¿½åŠ åˆ°æ­£åœ¨ä½¿ç”¨çš„`NSAutoreleasePool`å¯¹è±¡ä¸­çš„æ•°ç»„é‡Œã€‚
å½“ç„¶è¿™é‡Œåªæ˜¯é€‰ç”¨GNUstepæºç çš„è§£é‡Š, å®é™…Appleçš„å®ç°åˆ™æ›´ä¸ºå¤æ‚;

**è°ƒç”¨æµç¨‹**
å¦‚æœæˆ‘ä»¬æ‰‹åŠ¨åœ¨ä»£ç å¤–é¢å†å¥—ä¸€å±‚`autorelease`ï¼Œä»–å°±ä¼šè¢«æœ€è¿‘çš„`autoreleasepool`ç®¡ç†ï¼Œä¸€èˆ¬æ˜¯å½“å‰çº¿ç¨‹çš„é»˜è®¤åˆ›å»ºçš„`autoreleasepool`ï¼Œæ­¤`autoreleasepool`çš„é‡Šæ”¾æ—¶æœºä¸€èˆ¬æ˜¯å½“å‰`runloop`å¾ªç¯ç»“æŸï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°çš„ç°è±¡å°±æ˜¯å†…å­˜ä¸€ç›´é£™å‡ï¼Œç„¶åæ–­å´–å¼ä¸‹é™ã€‚

å…¶ä»–ç›¸å…³çš„ç‚¹:
ä½¿ç”¨å®¹å™¨çš„`block`ç‰ˆæœ¬çš„æšä¸¾å™¨æ—¶ï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ª`AutoreleasePool`;
```
[array enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) {
    // è¿™é‡Œè¢«ä¸€ä¸ªå±€éƒ¨@autoreleasepoolåŒ…å›´ç€
}];
```

å‚è€ƒ:
* [é»‘å¹•èƒŒåçš„Autorelease](http://blog.sunnyxx.com/2014/10/15/behind-autorelease/)
* [Revisit iOS Autorelease ä¹‹ä¸ç»æ„é—´å¯èƒ½è¢«å½±å“çš„ä¼˜åŒ–](https://www.sohu.com/a/336220048_208051)
