# åº•å±‚åŸç†ç¯‡
æœ¬ç¯‡æ‰“ç®—ä»¥è¾¹è¯´æ¦‚å¿µè¾¹è§£é—®é¢˜çš„æ–¹å¼æ·±å…¥æ¢è®¨iOSåº•å±‚ä¸€äº›é€»è¾‘é—®é¢˜,æœ‰ä»»ä½•é—®é¢˜æ¬¢è¿[issue](https://github.com/binzi56/iOSSmallKnowledgePool/issues);

### `@autoreleasepool`ä¸`autorelease`
åœ¨å¼€å‘ä¸­ç»å¸¸ç”¨`@autoreleasepool`æ¥è§£å†³`autorelease`äº§ç”Ÿçš„å†…å­˜é—®é¢˜;
ä¸¾ä¸ªğŸŒ°:
```
for (NSInteger i = 0; i < 10000000; i++) {
    @autoreleasepool {
        NSString *tempStr = [NSString stringWithFormat:@"ä¸´æ—¶å˜é‡"];
    }
}
```

ç®€è¿°
ç›®å‰åŒºåˆ†æ˜¯å¦ä½¿ç”¨äº†`autorelease`æŒ‰ä»¥ä¸‹è§„å¾‹:
> 1. ä½¿ç”¨alloc/new/copy/mutableCopy/init åˆ›å»ºä¸´æ—¶å¯¹è±¡ç›´æ¥è¿”å›è¢«retainå¯¹è±¡ï¼Œä¸ä¼šè¿›å…¥autoreleasepoolä¸­;(å…·ä½“çœ‹[ARCè§„å®š](https://clang.llvm.org/docs/AutomaticReferenceCounting.html#precise-lifetime-semantics), å®é™…ä½¿ç”¨ä¸Šå¸¸è§äºä¸€äº›å¯¹è±¡çš„æ„é€ æ–¹æ³•å³ç±»æ–¹æ³•)
> 2. ä½¿ç”¨å…¶å®ƒæ–¹æ³•åˆ›å»ºçš„ä¸´æ—¶å¯¹è±¡åˆ™ä¼šè‡ªåŠ¨å°†è¿”å›çš„å¯¹è±¡æ³¨å†Œåˆ°æ± å­ä¸­(æ³¨æ„:è¿™é‡Œæ˜¯è‡ªå·±ä¸æŒæœ‰çš„å¯¹è±¡);

å†é™„ä¸€ä¸ª`NSAutoreleasepool`çš„ç”Ÿå‘½å‘¨æœŸä»¥ä¾›è§‚èµ:
![NSAutoreleasepoolçš„ç”Ÿå‘½å‘¨æœŸ](https://upload-images.jianshu.io/upload_images/1893416-68279ed8c41752b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

Q1:`autorelease`å› ä½•å­˜åœ¨?
åœ¨OCçš„å†…å­˜ç®¡ç†æœºåˆ¶ä¸­æœ‰ä¸€æ¡è§„å¾‹æ˜¯ï¼šè°ç”³è¯·ï¼Œè°é‡Šæ”¾;
é‚£ä¹ˆå¦‚æœéœ€è¦å»¶é•¿ç”Ÿå‘½å‘¨æœŸæˆ–è€…æŸä¸ªæ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ªæ–°å»ºå¯¹è±¡å¹¶åœ¨åˆé€‚çš„æ—¶æœºæ¥é‡Šæ”¾,æ­¤æ—¶å°±éœ€è¦`autorelease`æ¥åº”å¯¹è¿™äº›æƒ…å†µ,è¿™æ ·æ—¢èƒ½ç¡®ä¿å¯¹è±¡èƒ½æ­£ç¡®é‡Šæ”¾ï¼Œåˆèƒ½è¿”å›æœ‰æ•ˆçš„å¯¹è±¡ã€‚

Q2:`autorelease`å’Œ`@autoreleasepool`å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„?
è¿™é‡Œç”¨[GNUstepæºç ](http://www.gnustep.org/resources/downloads.php)æ¥è§£é‡Š;
```
//autorelease
- (id)autorelease
{
    [NSAutoreleasePool addObject:self];
}
```

```
//@autoreleasepool
+ (void)addobject:(id)anObj{
    NSAutoreleasePool *pool = å–å¾—æ­£åœ¨ä½¿ç”¨çš„NSAutoreleasePoolå¯¹è±¡;
    if (pool != nil){
        [pool addobject:an0bj];
    }else{
        NSLog ( @"NSAutoreleasePoolå¯¹è±¡éå­˜åœ¨çŠ¶æ€ä¸‹è°ƒç”¨autorelease");
    }
}

- (void)addObject:(id)anObj
{
    [pool.array addObject:anObj];
}
```
`autorelease`å®ä¾‹æ–¹æ³•çš„æœ¬è´¨å°±æ˜¯è°ƒç”¨`NSAutoreleasePool`å¯¹è±¡çš„`addObject:`ç±»æ–¹æ³•ï¼Œç„¶åè¿™ä¸ªå¯¹è±¡å°±è¢«è¿½åŠ åˆ°æ­£åœ¨ä½¿ç”¨çš„`NSAutoreleasePool`å¯¹è±¡ä¸­çš„æ•°ç»„é‡Œã€‚
å½“ç„¶è¿™é‡Œåªæ˜¯é€‰ç”¨GNUstepæºç çš„è§£é‡Š, å®é™…Appleçš„å®ç°åˆ™æ›´ä¸ºå¤æ‚;

**è°ƒç”¨æµç¨‹**
å¦‚æœæˆ‘ä»¬æ‰‹åŠ¨åœ¨ä»£ç å¤–é¢å†å¥—ä¸€å±‚`autorelease`ï¼Œå®ƒå°±ä¼šè¢«æœ€è¿‘çš„`autoreleasepool`ç®¡ç†ï¼Œä¸€èˆ¬æ˜¯å½“å‰çº¿ç¨‹é»˜è®¤åˆ›å»ºçš„`autoreleasepool`ï¼Œæ­¤`autoreleasepool`çš„é‡Šæ”¾æ—¶æœºä¸€èˆ¬æ˜¯å½“å‰`runloop`å¾ªç¯ç»“æŸï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°çš„ç°è±¡å°±æ˜¯å†…å­˜ä¸€ç›´é£™å‡ï¼Œç„¶åæ–­å´–å¼ä¸‹é™ã€‚

å…¶ä»–ç›¸å…³çš„ç‚¹:
ä½¿ç”¨å®¹å™¨çš„`block`ç‰ˆæœ¬çš„æšä¸¾å™¨æ—¶ï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ª`AutoreleasePool`;
```
[array enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) {
    // è¿™é‡Œè¢«ä¸€ä¸ªå±€éƒ¨@autoreleasepoolåŒ…å›´ç€
}];
```

å‚è€ƒ:
* [é»‘å¹•èƒŒåçš„Autorelease](http://blog.sunnyxx.com/2014/10/15/behind-autorelease/)
* [Revisit iOS Autorelease ä¹‹ä¸ç»æ„é—´å¯èƒ½è¢«å½±å“çš„ä¼˜åŒ–](https://www.sohu.com/a/336220048_208051)


### `Runtime Method Swizzling`åŸç†
`Runtime Method Swizzling` ç¼–ç¨‹æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å«ä½œ`AOP`(`Aspect-Oriented Programming`ï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹)ã€‚
`AOP` æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œä½¿ç”¨ `AOP` å¯ä»¥è§£å†³ `OOP`(`Object Oriented Programming`ï¼Œé¢å‘å¯¹è±¡ç¼–
ç¨‹)ç”±äºåˆ‡é¢éœ€æ±‚å¯¼è‡´å•ä¸€èŒè´£è¢«ç ´åçš„é—®é¢˜ã€‚é€šè¿‡ `AOP` å¯ä»¥ä¸ä¾µå…¥ `OOP` å¼€å‘ï¼Œéå¸¸æ–¹ä¾¿åœ°æ’å…¥åˆ‡é¢éœ€æ±‚åŠŸèƒ½ã€‚

#### ç›´æ¥ä½¿ç”¨ Runtime æ–¹æ³•äº¤æ¢å¼€å‘çš„â»›é™©æœ‰å“ªäº›?
`Runtime` ä¸å…‰èƒ½å¤Ÿè¿›è¡Œæ–¹æ³•äº¤æ¢ï¼Œè¿˜èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶å¤„ç† `Objective-C` ç‰¹æ€§ç›¸å…³(æ¯”å¦‚ç±»ã€æˆå‘˜å‡½æ•°ã€ç»§æ‰¿)çš„å¢åˆ æ”¹æ“ä½œã€‚
è‹¹æœå…¬å¸å·²ç»å¼€æºäº†`Runtime`ï¼Œåœ¨ `GitHub` ä¸Šæœ‰[å¯ç¼–è¯‘çš„ Runtime å¼€æºç‰ˆæœ¬](https://github.com/0xxd0/objc4)ã€‚
ä½ å¯ä»¥é€šè¿‡äºå¾·å¿— (@halfrost)åšå®¢çš„ä¸‰ç¯‡ Runtime æ–‡ç« ï¼Œå³[isaå’ŒClass](https://halfrost.com/objc_runtime_isa_class/)ã€[æ¶ˆæ¯å‘é€ä¸è½¬å‘](https://halfrost.com/objc_runtime_objc_msgsend/)ï¼Œä»¥åŠ[å¦‚ä½•æ­£ç¡®ä½¿ç”¨Runtime](https://halfrost.com/how_to_use_runtime/)ï¼Œæ¥ä¸€è¾¹å­¦ä¹ ä¸€è¾¹è°ƒè¯•ã€‚
ç›´æ¥ä½¿ç”¨`Runtime`çš„æ–¹å¼å¦‚ä¸‹:
```
#import "ZBHook.h"
#import <objc/runtime.h>

@implementation ViewHook

+ (void)hookClass:(Class)classObject fromSelector:(SEL)fromSelector toSelector:(SEL)toSelector {
    Class class = classObject;
    // å¾—åˆ°è¢«æ›¿æ¢ç±»çš„å®ä¾‹æ–¹æ³•
    Method fromMethod = class_getInstanceMethod(class, fromSelector);
    // å¾—åˆ°æ›¿æ¢ç±»çš„å®ä¾‹æ–¹æ³•
    Method toMethod = class_getInstanceMethod(class, toSelector);

    // class_addMethod è¿”å›æˆåŠŸè¡¨ç¤ºè¢«æ›¿æ¢çš„æ–¹æ³•æ²¡å®ç°ï¼Œç„¶åä¼šé€šè¿‡ class_addMethod æ–¹æ³•å…ˆå®ç°ï¼›è¿”å›å¤±è´¥åˆ™è¡¨ç¤ºè¢«æ›¿æ¢æ–¹æ³•å·²å­˜åœ¨ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œ IMP æŒ‡é’ˆäº¤æ¢
    if(class_addMethod(class, fromSelector, method_getImplementation(toMethod), method_getTypeEncoding(toMethod))) {
      // è¿›è¡Œæ–¹æ³•çš„æ›¿æ¢
        class_replaceMethod(class, toSelector, method_getImplementation(fromMethod), method_getTypeEncoding(fromMethod));
    } else {
      // äº¤æ¢ IMP æŒ‡é’ˆ
        method_exchangeImplementations(fromMethod, toMethod);
    }

}

@end

```
[RSSwizzle](https://github.com/rabovik/RSSwizzle/)åº“é‡ŒæŒ‡å‡ºäº†å››ä¸ªå…¸å‹çš„ç›´æ¥ä½¿ç”¨ `Runtime` æ–¹æ³•è¿›è¡Œæ–¹æ³•äº¤æ¢çš„â»›é™©ã€‚æ•´ç†å¦‚ä¸‹:
* ç¬¬ä¸€ä¸ªâ»›é™©æ˜¯ï¼Œéœ€è¦åœ¨ `+load` æ–¹æ³•ä¸­è¿›è¡Œæ–¹æ³•äº¤æ¢ã€‚å› ä¸ºå¦‚æœåœ¨å…¶ä»–æ—¶å€™è¿›è¡Œæ–¹æ³•äº¤æ¢ï¼Œéš¾ä»¥ä¿è¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­ä¸ä¼šåŒæ—¶è°ƒç”¨è¢«äº¤æ¢çš„æ–¹æ³•ï¼Œä»è€Œå¯¼è‡´ç¨‹åºä¸èƒ½æŒ‰é¢„æœŸæ‰§è¡Œã€‚
* ç¬¬äºŒä¸ªâ»›é™©æ˜¯ï¼Œè¢«äº¤æ¢çš„æ–¹æ³•å¿…é¡»æ˜¯å½“å‰ç±»çš„æ–¹æ³•ï¼Œä¸èƒ½æ˜¯çˆ¶ç±»çš„æ–¹æ³•ï¼Œç›´æ¥æŠŠçˆ¶ç±»çš„å®ç°æ‹·â»‰è¿‡æ¥ä¸ä¼šèµ·ä½œç”¨ã€‚çˆ¶ç±»çš„æ–¹æ³•å¿…é¡»åœ¨è°ƒç”¨çš„æ—¶å€™ä½¿ç”¨ï¼Œè€Œä¸æ˜¯æ–¹æ³•äº¤æ¢æ—¶ä½¿ç”¨ã€‚
* ç¬¬ä¸‰ä¸ªâ»›é™©æ˜¯ï¼Œäº¤æ¢çš„æ–¹æ³•å¦‚æœä¾èµ–äº† `cmd`ï¼Œé‚£ä¹ˆäº¤æ¢åï¼Œå¦‚æœ `cmd` å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±ä¼šå‡ºç°å„ç§å¥‡æ€ªé—®é¢˜ï¼Œè€Œä¸”è¿™äº›é—®é¢˜è¿˜å¾ˆéš¾æ’æŸ¥ã€‚ç‰¹åˆ«æ˜¯äº¤æ¢äº†ç³»ç»Ÿæ–¹æ³•ï¼Œä½ æ— æ³•ä¿è¯ç³»ç»Ÿæ–¹æ³•å†…éƒ¨æ˜¯å¦ä¾èµ–äº† `cmd`ã€‚
* ç¬¬å››ä¸ªâ»›é™©æ˜¯ï¼Œæ–¹æ³•äº¤æ¢å‘½åå†²çªã€‚å¦‚æœå‡ºç°å†²çªï¼Œå¯èƒ½ä¼šå¯¼è‡´æ–¹æ³•äº¤æ¢å¤±è´¥ã€‚
æ›´å¤šå…³äºè¿è¡Œæ—¶æ–¹æ³•äº¤æ¢çš„â»›é™©ï¼Œä½ å¯ä»¥æŸ¥çœ‹ `Stackoverflow` ä¸Šçš„é—®é¢˜è®¨è®ºâ€œ[What are the Dangers of Method Swizzling in Objective C?](https://stackoverflow.com/questions/5339276/what-are-the-dangers-of-method-swizzling-in-objective-c)â€ã€‚

#### å…³äº`Runtime`ç³»ç»Ÿæ‰€åšçš„ä¼˜åŒ–
1. **æ–¹æ³•åˆ—è¡¨çš„ç¼“å­˜**
åœ¨æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­ï¼ŒæŸ¥æ‰¾IMPçš„è¿‡ç¨‹ï¼Œä¼šä¼˜å…ˆæŸ¥æ‰¾ç¼“å­˜ã€‚è¿™ä¸ªç¼“å­˜ä¼šå­˜å‚¨æœ€è¿‘ä½¿ç”¨è¿‡çš„æ–¹æ³•éƒ½ç¼“å­˜èµ·æ¥ã€‚è¿™ä¸ª`cache`å’Œ`CPU`é‡Œé¢çš„`cache`çš„å·¥ä½œæ–¹å¼æœ‰ç‚¹ç±»ä¼¼ã€‚åŸç†æ˜¯è°ƒç”¨çš„æ–¹æ³•æœ‰å¯èƒ½ç»å¸¸ä¼šè¢«è°ƒç”¨ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªç¼“å­˜ï¼Œç›´æ¥å»ç±»æ–¹æ³•çš„æ–¹æ³•é“¾è¡¨é‡Œé¢å»æŸ¥æ‰¾ï¼ŒæŸ¥è¯¢æ•ˆç‡å®åœ¨å¤ªä½ã€‚æ‰€ä»¥æŸ¥æ‰¾`IMP`ä¼šä¼˜å…ˆæœç´¢æ–¹æ³•ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ¥ç€ä¼šåœ¨è™šå‡½æ•°è¡¨ä¸­å¯»æ‰¾`IMP`ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ä¼šæŠŠè¿™ä¸ªIMPå­˜å‚¨åˆ°ç¼“å­˜ä¸­å¤‡ç”¨ã€‚

åŸºäºè¿™ä¸ªè®¾è®¡ï¼Œä½¿`Runtime`ç³»ç»Ÿèƒ½èƒ½å¤Ÿæ‰§è¡Œå¿«é€Ÿé«˜æ•ˆçš„æ–¹æ³•æŸ¥è¯¢æ“ä½œã€‚

2. **è™šå‡½æ•°è¡¨**
è™šå‡½æ•°è¡¨ä¹Ÿç§°ä¸ºåˆ†æ´¾è¡¨ï¼Œæ˜¯ç¼–ç¨‹è¯­è¨€ä¸­å¸¸ç”¨çš„åŠ¨æ€ç»‘å®šæ”¯æŒæœºåˆ¶ã€‚åœ¨`OC`çš„`Runtime`è¿è¡Œæ—¶ç³»ç»Ÿåº“å®ç°äº†ä¸€ç§è‡ªå®šä¹‰çš„è™šå‡½æ•°è¡¨åˆ†æ´¾æœºåˆ¶ã€‚è¿™ä¸ªè¡¨æ˜¯ä¸“é—¨ç”¨æ¥æé«˜æ€§èƒ½å’Œçµæ´»æ€§çš„ã€‚è¿™ä¸ªè™šå‡½æ•°è¡¨æ˜¯ç”¨æ¥å­˜å‚¨`IMP`ç±»å‹çš„æ•°ç»„ã€‚æ¯ä¸ª`object-class`éƒ½æœ‰è¿™æ ·ä¸€ä¸ªæŒ‡å‘è™šå‡½æ•°è¡¨çš„æŒ‡é’ˆã€‚

3. **dyldå…±äº«ç¼“å­˜**
åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­ï¼Œä¸€å®šä¼šæœ‰å¾ˆå¤šè‡ªå®šä¹‰ç±»ï¼Œè€Œè¿™äº›ç±»ä¸­ï¼Œå¾ˆå¤š`SEL`æ˜¯é‡åçš„ï¼Œæ¯”å¦‚`alloc`ï¼Œ`init`ç­‰ç­‰ã€‚`Runtime`ç³»ç»Ÿéœ€è¦ä¸ºæ¯ä¸€ä¸ªæ–¹æ³•ç»™å®šä¸€ä¸ª`SEL`æŒ‡é’ˆï¼Œç„¶åä¸ºæ¯æ¬¡è°ƒç”¨ä¸ªå„ä¸ªæ–¹æ³•æ›´æ–°å…ƒæ•°æ®ï¼Œä»¥è·å–å”¯ä¸€å€¼ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™å®Œæˆã€‚ä¸ºäº†æé«˜è¿™ä¸€éƒ¨åˆ†çš„æ‰§è¡Œæ•ˆç‡ï¼Œ`Runtime`ä¼šé€šè¿‡`dyld`å…±äº«ç¼“å­˜å®ç°é€‰æ‹©å™¨çš„å”¯ä¸€æ€§ã€‚

`dyld`æ˜¯ä¸€ç§ç³»ç»ŸæœåŠ¡ï¼Œç”¨äºå®šä½å’ŒåŠ è½½åŠ¨æ€åº“ã€‚å®ƒå«æœ‰å…±äº«ç¼“å­˜ï¼Œèƒ½å¤Ÿä½¿å¤šä¸ªè¿›ç¨‹å…±ç”¨è¿™äº›åŠ¨æ€åº“ã€‚`dyld`å…±äº«ç¼“å­˜ä¸­å«æœ‰ä¸€ä¸ªé€‰æ‹©å™¨è¡¨ï¼Œä»è€Œèƒ½ä½¿è¿è¡Œæ—¶ç³»ç»Ÿèƒ½å¤Ÿé€šè¿‡ä½¿ç”¨ç¼“å­˜è®¿é—®å…±äº«åº“å’Œè‡ªå®šä¹‰ç±»çš„é€‰æ‹©å™¨ã€‚

å…³äº`dyld`çš„çŸ¥è¯†å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« `dyld`: [Dynamic Linking On OS X](https://www.mikeash.com/pyblog/friday-qa-2012-11-09-dyld-dynamic-linking-on-os-x.html)

#### æ›´å®‰å…¨çš„æ–¹æ³•äº¤æ¢åº“`Aspects`
[Aspects](https://github.com/steipete/Aspects)æ˜¯ä¸€ä¸ªé€šè¿‡ `Runtime` æ¶ˆæ¯è½¬å‘æœºåˆ¶æ¥å®ç°æ–¹æ³•äº¤æ¢çš„åº“ã€‚å®ƒå°†æ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨éƒ½æŒ‡åˆ° `_objc_msgForward` å‡½æ•°è°ƒç”¨ä¸Šï¼ŒæŒ‰ç…§è‡ªå·±çš„æ–¹å¼å®ç°äº†æ¶ˆæ¯è½¬å‘ï¼Œè‡ªå·±å¤„ç†å‚æ•°åˆ—è¡¨ï¼Œå¤„ç†è¿”å›å€¼ï¼Œæœ€åé€šè¿‡ `NSInvocation` è°ƒç”¨æ¥å®ç°æ–¹æ³•äº¤æ¢ã€‚åŒæ—¶ï¼Œ`Aspects` è¿˜è€ƒè™‘äº†ä¸€äº›æ–¹æ³•äº¤æ¢å¯èƒ½ä¼šå¼•å‘çš„â»›é™©ï¼Œå¹¶è¿›è¡Œäº†å¤„ç†ã€‚

#### `objc_msgSend`ä¸ºä»€ä¹ˆä½¿ç”¨æ±‡ç¼–
1. åœ¨Cè¯­è¨€é‡Œé¢è°ƒç”¨å‡½æ•°ï¼Œå¿…é¡»åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“è°ƒç”¨çš„â€œçŠ¶æ€â€ï¼›è€Œè¿™äº›â€œçŠ¶æ€â€åœ¨è¿è¡Œæ—¶æ˜¯æ— æ³•å¾—å‡ºæˆ–æ­£ç¡®å¤„ç†çš„ï¼Œæ‰€ä»¥å¿…é¡»å¾€åº•å±‚èµ°ï¼Œç”¨æ±‡ç¼–å¤„ç†ã€‚
2. ä½¿ç”¨æ•ˆç‡è€ƒè™‘, æ¯•ç«Ÿæ˜¯è¢«è°ƒç”¨æ¬¡æ•°æœ€å¤šçš„æ–¹æ³•;
3. æ–¹æ³•çš„è°ƒç”¨å‚æ•°å’Œè¿”å›å€¼ç±»å‹å¤šæ ·åŒ–, ä¸€èˆ¬æ–¹æ³•æ— æ³•åšåˆ°;

### è‡ªæ—‹é”å’Œäº’æ–¥é”
1. äº’æ–¥é”: åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—äº’æ–¥é”,å…¶ä½™çº¿ç¨‹å¤„äºæŒ‚èµ·çŠ¶æ€.
2. è‡ªæ—‹é”: å½“æŸä¸ªçº¿ç¨‹è·å¾—è‡ªæ—‹é”å,åˆ«çš„çº¿ç¨‹ä¼šä¸€ç›´åšå¾ªç¯,å°è¯•åŠ é”,å½“è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å¾—é”æ—¶,çº¿ç¨‹ä¹Ÿä¼šè¢«æŒ‚èµ·.

æ€»ç»“ï¼š
* è‡ªæ—‹é”ä¼šå¿™ç­‰: æ‰€è°“å¿™ç­‰ï¼Œå³åœ¨è®¿é—®è¢«é”èµ„æºæ—¶ï¼Œè°ƒç”¨è€…çº¿ç¨‹ä¸ä¼šä¼‘çœ ï¼Œè€Œæ˜¯ä¸åœå¾ªç¯åœ¨é‚£é‡Œï¼Œç›´åˆ°è¢«é”èµ„æºé‡Šæ”¾é”ã€‚
* äº’æ–¥é”ä¼šä¼‘çœ : æ‰€è°“ä¼‘çœ ï¼Œå³åœ¨è®¿é—®è¢«é”èµ„æºæ—¶ï¼Œè°ƒç”¨è€…çº¿ç¨‹ä¼šä¼‘çœ ï¼Œæ­¤æ—¶`cpu`å¯ä»¥è°ƒåº¦å…¶ä»–çº¿ç¨‹å·¥ä½œã€‚ç›´åˆ°è¢«é”èµ„æºé‡Šæ”¾é”ã€‚æ­¤æ—¶ä¼šå”¤é†’ä¼‘çœ çº¿ç¨‹ã€‚

ä¼˜ç¼ºç‚¹ï¼š
* è‡ªæ—‹é”çš„ä¼˜ç‚¹åœ¨äºï¼Œå› ä¸ºè‡ªæ—‹é”ä¸ä¼šå¼•èµ·è°ƒç”¨è€…ç¡çœ ï¼Œæ‰€ä»¥ä¸ä¼šè¿›è¡Œçº¿ç¨‹è°ƒåº¦ï¼Œ`cpu`æ—¶é—´ç‰‡è½®è½¬ç­‰è€—æ—¶æ“ä½œã€‚æ‰€æœ‰å¦‚æœèƒ½åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…è·å¾—é”ï¼Œè‡ªæ—‹é”çš„æ•ˆç‡è¿œé«˜äºäº’æ–¥é”ã€‚
* ç¼ºç‚¹åœ¨äºï¼Œè‡ªæ—‹é”ä¸€ç›´å ç”¨`CPU`ï¼Œä»–åœ¨æœªè·å¾—é”çš„æƒ…å†µä¸‹ï¼Œä¸€ç›´è¿è¡Œï¼ï¼è‡ªæ—‹ï¼Œæ‰€ä»¥å ç”¨ç€`CPU`ï¼Œå¦‚æœä¸èƒ½åœ¨å¾ˆçŸ­çš„æ—¶ é—´å†…è·å¾—é”ï¼Œè¿™æ— ç–‘ä¼šä½¿`CPU`æ•ˆç‡é™ä½ã€‚è‡ªæ—‹é”ä¸èƒ½å®ç°é€’å½’è°ƒç”¨ã€‚

è‡ªæ—‹é”ï¼š`atomic`ã€`OSSpinLock`ã€`dispatch_semaphore_t`
äº’æ–¥é”ï¼š`pthread_mutex`ã€`@synchronized`ã€`NSLock`ã€`NSConditionLock` ã€`NSCondition`ã€`NSRecursiveLock`

* [iOS å¤šçº¿ç¨‹é¢è¯•é¢˜ï¼ˆè‡ªæ—‹é”ä¸äº’æ–¥é”ï¼‰](https://www.jianshu.com/p/80043c824d2d)
* [çº¿ç¨‹å®‰å…¨: äº’æ–¥é”å’Œè‡ªæ—‹é”(10ç§)](http://www.cocoachina.com/articles/25513)
* [æ·±å…¥ç†è§£iOSå¼€å‘ä¸­çš„é”](https://link.jianshu.com/?t=https://bestswifter.com/ios-lock/#osspinlock)

### åŠ¨æ€è°ƒç”¨å’Œå®šä¹‰Cå‡½æ•°
**å¦‚ä½•åŠ¨æ€åœ°è°ƒç”¨Cå‡½æ•°?**
é«˜çº§ç¼–ç¨‹è¯­è¨€çš„å‡½æ•°åœ¨è°ƒç”¨æ—¶ï¼Œéœ€è¦çº¦å®šå¥½å‚æ•°çš„ä¼ é€’é¡ºåºã€ä¼ é€’æ–¹å¼ï¼Œæ ˆç»´æŠ¤çš„æ–¹å¼ï¼Œåå­—ä¿®é¥°ã€‚è¿™ç§å‡½æ•°è°ƒç”¨è€…å’Œè¢«è°ƒç”¨
è€…å¯¹å‡½æ•°å¦‚ä½•è°ƒç”¨çš„çº¦å®šï¼Œå°±å«ä½œè°ƒç”¨æƒ¯ä¾‹(`Calling Convention`)ã€‚é«˜çº§è¯­è¨€ç¼–è¯‘æ—¶ï¼Œä¼šç”Ÿæˆéµå¾ªè°ƒç”¨æƒ¯ä¾‹çš„ä»£ç ã€‚
æ‰€ä»¥ï¼Œç¼–è¯‘æ—¶éœ€è¦æŒ‰ç…§è°ƒç”¨æƒ¯ä¾‹é’ˆå¯¹ä¸åŒ `CPU` æ¶æ„ç¼–è¯‘ï¼Œç”Ÿæˆæ±‡ç¼–ä»£ç ï¼Œç¡®å®šå¥½æ ˆå’Œå¯„å­˜å™¨ã€‚ å¦‚æœå°‘äº†ç¼–è¯‘è¿‡ç¨‹ï¼Œç›´æ¥åœ¨è¿è¡Œæ—¶å»åŠ¨æ€åœ°è°ƒç”¨å‡½æ•°ï¼Œå°±éœ€è¦å…ˆç”ŸæˆåŠ¨æ€è°ƒç”¨ç›¸åº”å¯„å­˜å™¨å’Œæ ˆçŠ¶æ€çš„æ±‡ç¼–æŒ‡ä»¤ã€‚è€Œè¦è¾¾åˆ°äº‹å…ˆç”Ÿæˆç›¸åº”å¯„å­˜å™¨å’Œæ ˆçš„ç›®çš„ï¼Œ å°±ä¸èƒ½ä½¿ç”¨éµå¾ªè°ƒç”¨æƒ¯ä¾‹çš„é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œè€Œéœ€è¦ä½¿ç”¨æ±‡ç¼–è¯­è¨€ã€‚

#### `libffi`
[libffi](https://github.com/libffi/libffi) ä¸­`ffi`çš„å…¨ç§°æ˜¯ `Foreign Function Interface`(å¤–éƒ¨å‡½æ•°æ¥å£)ï¼Œæä¾›æœ€åº•å±‚çš„æ¥å£ï¼Œåœ¨ä¸ç¡®å®šå‚æ•°ä¸ªæ•°å’Œç±»å‹çš„æƒ…å†µä¸‹ï¼Œæ ¹æ®ç›¸åº”è§„åˆ™ï¼Œå®Œæˆæ‰€éœ€æ•°æ®çš„å‡†å¤‡ï¼Œç”Ÿæˆç›¸åº”æ±‡ç¼–æŒ‡ä»¤çš„ä»£ç æ¥å®Œæˆå‡½æ•°è°ƒç”¨ã€‚
`libffi` è¿˜æä¾›äº†å¯ç§»æ¤çš„é«˜çº§è¯­è¨€æ¥å£ï¼Œå¯ä»¥ä¸ä½¿ç”¨å‡½æ•°ç­¾åé—´æ¥è°ƒç”¨ C å‡½æ•°ã€‚æ¯”å¦‚ï¼Œè„šæœ¬è¯­è¨€ `Python` åœ¨è¿è¡Œæ—¶ä¼šä½¿ç”¨ `libffi` é«˜çº§è¯­è¨€çš„æ¥å£å»è°ƒç”¨ `C` å‡½æ•°ã€‚`libffi`çš„ä½œç”¨ç±»ä¼¼äºä¸€ä¸ªåŠ¨æ€çš„ç¼–è¯‘å™¨ï¼Œåœ¨è¿è¡Œæ—¶å°±èƒ½å¤Ÿå®Œæˆç¼–è¯‘æ—¶æ‰€åšçš„è°ƒç”¨æƒ¯ä¾‹å‡½æ•°è°ƒç”¨ä»£ç ç”Ÿæˆã€‚
`libffi` é€šè¿‡è°ƒç”¨ `ffi_call`(å‡½æ•°è°ƒç”¨) æ¥è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œ`ffi_call` çš„è¾“å…¥æ˜¯ `ffi_cif`(æ¨¡æ¿)ã€å‡½æ•°æŒ‡é’ˆã€å‚æ•°åœ°å€ã€‚å…¶ä¸­ï¼Œ`ffi_cif` ç”± `ffi_type`(å‚æ•°ç±»å‹) å’Œå‚æ•°ä¸ªæ•°ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥æ˜¯ `ffi_closure`(é—­åŒ…)ã€‚

* [å­™æºåœ¨GitHubä½¿ç”¨Demo(åŠ¨æ€å®šä¹‰Cå‡½æ•°å’ŒåŠ¨æ€è°ƒç”¨Cå‡½æ•°)](https://github.com/sunnyxx/libffi-iOS)

### `iOS`æ˜¯æ€ä¹ˆç®¡ç†å†…å­˜çš„
ä¸åŒçš„ç³»ç»Ÿç‰ˆæœ¬å¯¹ `App` è¿è¡Œæ—¶å ç”¨å†…å­˜çš„é™åˆ¶ä¸åŒ, å…·ä½“é™åˆ¶[æŸ¥çœ‹è¿™é‡Œ](https://www.jianshu.com/p/301984616398);
ç§»åŠ¨ç«¯çš„å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œä¸»è¦æœ‰ `GC`(`Garbage Collection`ï¼Œåƒåœ¾å›æ”¶)çš„æ ‡è®°æ¸…é™¤ç®—æ³•å’Œè‹¹æœå…¬å¸ä½¿ç”¨çš„å¼•ç”¨è®¡æ•°æ–¹æ³•ã€‚
ç›¸æ¯”è¾ƒäº `GC` æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œå¼•ç”¨è®¡æ•°æ³•å¯ä»¥åŠæ—¶åœ°å›æ”¶å¼•ç”¨è®¡æ•°ä¸º`0`çš„å¯¹è±¡ï¼Œå‡å°‘æŸ¥æ‰¾æ¬¡æ•°ã€‚ä½†æ˜¯ï¼Œå¼•ç”¨è®¡æ•°ä¼šå¸¦æ¥å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œæ¯”å¦‚å½“å¤–éƒ¨çš„å˜é‡å¼ºå¼•ç”¨ `Block`æ—¶ï¼Œ`Block`ä¹Ÿä¼šå¼ºå¼•ç”¨å¤–éƒ¨çš„å˜é‡ï¼Œå°±ä¼šå‡ºç°å¾ªç¯å¼•ç”¨ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡å¼±å¼•ç”¨ï¼Œæ¥è§£é™¤å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚

#### è™šæ‹Ÿå†…å­˜
ç”±äºè¦è§£å†³å¤šç¨‹åºå¤šä»»åŠ¡åŒæ—¶è¿è¡Œæœ‰å¯èƒ½å¯¼è‡´ä»¥ä¸‹é—®é¢˜:
* åŒæ—¶è¿è¡Œçš„ç¨‹åºå ç”¨çš„æ€»å†…å­˜å¿…é¡»è¦å°äºå®é™…ç‰©ç†å†…å­˜å¤§å°
* ç¨‹åºèƒ½å¤Ÿç›´æ¥è®¿é—®å’Œä¿®æ”¹ç‰©ç†å†…å­˜ï¼Œä¹Ÿå°±èƒ½ å¤Ÿç›´æ¥è®¿é—®å’Œä¿®æ”¹å…¶ä»–ç¨‹åºæ‰€ä½¿ç”¨çš„ç‰©ç†å†…å­˜ï¼Œç¨‹åºè¿è¡Œæ—¶çš„å®‰å…¨å°±æ— æ³•ä¿éšœ

æ‰€ä»¥å¢åŠ äº†ä¸€ä¸ªä¸­é—´å±‚æ¥é—´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œè¿™ä¸ªä¸­é—´å±‚å°±æ˜¯è™šæ‹Ÿå†…å­˜ã€‚è™šæ‹Ÿå†…å­˜é€šè¿‡æ˜ å°„ï¼Œå¯ä»¥å°†è™šæ‹Ÿåœ°å€è½¬åŒ–æˆç‰©ç†åœ°å€ã€‚

æ¯ä¸ªç¨‹åºéƒ½æœ‰è‡ªå·±çš„è¿›ç¨‹ï¼Œè¿›ç¨‹çš„å†…å­˜å¸ƒå±€ä¸»è¦ç”±ä»£ç æ®µã€æ•°æ®æ®µã€æ ˆã€å †ç»„æˆã€‚ç¨‹åºç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¼šæ”¾åœ¨ä»£ç æ®µã€‚å¦‚æœæ¯ä¸ªè¿›ç¨‹çš„å†…å­˜å¸ƒå±€éƒ½æ˜¯è¿åœ¨ä¸€èµ·çš„è¯ï¼Œæ¯ä¸ªè¿›ç¨‹åˆ†é…çš„ç©ºé—´å°±æ²¡æ³•**çµæ´»å˜æ›´**ï¼Œ**æ ˆå’Œå †æ²¡ç”¨æ»¡**æ—¶å°±ä¼šæœ‰å¾ˆå¤šæ²¡ç”¨çš„ç©ºé—´ã€‚å¦‚æœè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„ç¿»è¯‘å†…å­˜ç®¡ç†å•å…ƒ(`Memory Management Unitï¼ŒMMU`)åªæ˜¯ç®€å•åœ°é€šè¿‡è¿›ç¨‹å¼€å§‹åœ°å€åŠ ä¸Šè™šæ‹Ÿåœ°å€ï¼Œæ¥è·å–ç‰©ç†åœ°å€ï¼Œå°±ä¼šé€ æˆå¾ˆå¤§çš„**å†…å­˜ç©ºé—´æµªè´¹**ã€‚

### åˆ†æ®µ
åˆ†æ®µå°±æ˜¯å°†è¿›ç¨‹é‡Œè¿åœ¨ä¸€èµ·çš„ä»£ç æ®µã€æ•°æ®æ®µã€æ ˆã€å †åˆ†å¼€æˆç‹¬ç«‹çš„æ®µï¼Œæ¯ä¸ªæ®µå†…ç©ºé—´æ˜¯è¿ç»­çš„ï¼Œæ®µä¹‹é—´ä¸è¿ç»­ã€‚è¿™æ ·ï¼Œå†…å­˜çš„ç©ºé—´ç®¡ç† `MMU` å°±å¯ä»¥æ›´åŠ çµæ´»åœ°è¿›è¡Œå†…å­˜ç®¡ç†ã€‚

é‚£ä¹ˆï¼Œæ®µå’Œè¿›ç¨‹å…³ç³»æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„å‘¢?è¿›ç¨‹ä¸­å†…å­˜åœ°å€ä¼šç”¨**å‰ä¸¤ä¸ªå­—èŠ‚**è¡¨ç¤ºå¯¹åº”çš„æ®µã€‚æ¯”å¦‚00è¡¨ç¤ºä»£ç æ®µï¼Œ01æ ‡è¯†å †ã€‚

æ®µé‡Œçš„è¿›ç¨‹åˆæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜çš„å‘¢?æ¯ä¸ªæ®µå¤§å°å¢â»“çš„æ–¹å‘ `Grows Positive` ä¹Ÿéœ€è¦è®°å½•ï¼Œæ˜¯å¦å¯è¯»å†™ä¹Ÿè¦è®°å½•ï¼Œä¸ºçš„æ˜¯èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°ç®¡ç†æ®µå¢â»“ã€‚æ¯ä¸ª**æ®µçš„å¤§å°**ä¸ä¸€æ ·ï¼Œåœ¨ç”³è¯·çš„å†…å­˜è¢«**é‡Šæ”¾**åï¼Œ**å®¹æ˜“äº§ç”Ÿç¢ç‰‡**ï¼Œè¿™æ ·åœ¨**ç”³è¯·æ–°å†…å­˜**æ—¶ï¼Œå¾ˆå¯èƒ½å°±ä¼šå‡ºç°**æ‰€å‰©å†…å­˜ç©ºé—´å¤Ÿç”¨**ï¼Œä½†æ˜¯å´ä¸è¿ç»­ï¼Œäºæ˜¯é€ æˆ**æ— æ³•ç”³è¯·**çš„æƒ…å†µã€‚è¿™æ—¶ï¼Œå°±éœ€è¦**æš‚åœè¿è¡Œè¿›ç¨‹**ï¼Œå¯¹æ®µè¿›è¡Œä¿®æ”¹ï¼Œç„¶åå†å°†**å†…å­˜æ‹·â»‰åˆ°è¿ç»­çš„åœ°å€ç©ºé—´ä¸­**ã€‚ä½†æ˜¯ï¼Œ**è¿ç»­æ‹·â»‰ä¼šè€—è´¹è¾ƒå¤šæ—¶é—´**ã€‚

é‚£ä¹ˆï¼Œæ€ä¹ˆæ‰èƒ½é™ä½å†…å­˜çš„ç¢ç‰‡åŒ–ç¨‹åº¦ï¼Œè¿›è€Œæé«˜æ€§èƒ½å‘¢?

### åˆ†é¡µ
`App` åœ¨è¿è¡Œæ—¶ï¼Œå¤§å¤šæ•°çš„æ—¶é—´åªä¼šä½¿ç”¨å¾ˆå°éƒ¨åˆ†çš„å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¯”æ®µç²’åº¦æ›´å°çš„ç©ºé—´ç®¡ç†æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯åˆ†â»šã€‚

åˆ†â»šå°±æ˜¯æŠŠ**åœ°å€ç©ºé—´åˆ‡åˆ†æˆå›ºå®šå¤§å°çš„å•å…ƒ**ï¼Œè¿™æ ·æˆ‘ä»¬å°±**ä¸ç”¨å»è€ƒè™‘å †å’Œæ ˆä¼šå…·ä½“ç”³è¯·å¤šå°‘ç©ºé—´**ï¼Œè€Œåªè¦è€ƒè™‘éœ€è¦å¤šå°‘â»šå°±å¯ä»¥äº†ã€‚è¿™å¯¹äºæ“ä½œç³»ç»Ÿç®¡ç†æ¥è¯´ä¹Ÿä¼šç®€å•å¾ˆå¤šï¼Œåªéœ€è¦ç»´æŠ¤ä¸€ä»½â»šè¡¨(`Page Table`)æ¥è®°å½•**è™šæ‹Ÿâ»š**(`Virtual Page`)å’Œ**ç‰©ç†â»š**(`Physical Page`)çš„å…³ç³»å³å¯ã€‚

è™šæ‹Ÿâ»šçš„å‰ä¸¤ä½æ˜¯ `VPN`(`Virtual Page Number`)ï¼Œæ ¹æ®â»šè¡¨ï¼Œç¿»è¯‘ä¸ºç‰©ç†åœ°å€ `PFN`(`Physical Frame Number`)ã€‚

ç»´æŠ¤è™šæ‹Ÿâ»šå’Œç‰©ç†â»šå…³ç³»çš„**â»šè¡¨ä¼šéšç€è¿›ç¨‹å¢å¤šè€Œå˜å¾—è¶Šæ¥è¶Šå¤§**ï¼Œå½“â»šè¡¨å¤§äºå¯„å­˜å™¨å¤§å°æ—¶ï¼Œå°±æ— æ³•æ”¾åˆ°å¯„å­˜å™¨ä¸­ï¼Œ**åªèƒ½æ”¾åˆ°å†…å­˜**ä¸­ã€‚å½“è¦é€šè¿‡è™šæ‹Ÿåœ°å€è·å–ç‰©ç†åœ°å€çš„æ—¶å€™ï¼Œå°±è¦å¯¹â»šè¡¨è¿›è¡Œè®¿é—®ç¿»è¯‘ï¼Œè€Œåœ¨**å†…å­˜ä¸­è¿›è¡Œè®¿é—®ç¿»è¯‘çš„é€Ÿåº¦ä¼šæ¯”`CPU`çš„å¯„å­˜å™¨æ…¢å¾ˆå¤š**ã€‚

***æ€ä¹ˆåŠ é€Ÿâ»šè¡¨ç¿»è¯‘é€Ÿåº¦å‘¢?***
æˆ‘ä»¬çŸ¥é“ï¼Œç¼“å­˜å¯ä»¥åŠ é€Ÿè®¿é—®ã€‚`MMU` ä¸­æœ‰ä¸€ä¸ª `TLB`(`Translation-Lookaside Buffer`)ï¼Œå¯ä»¥ä½œä¸ºç¼“å­˜åŠ é€Ÿè®¿é—®ã€‚æ‰€ä»¥ï¼Œåœ¨è®¿
é—®â»šè¡¨å‰ï¼Œé¦–å…ˆæ£€æŸ¥ `TLB` æœ‰æ²¡æœ‰ç¼“å­˜çš„è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€:
* å¦‚æœæœ‰çš„è¯ï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ï¼Œè€Œä¸ç”¨å†å»è®¿é—®â»šè¡¨äº†;
* å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå°±éœ€è¦ç»§ç»­è®¿é—®â»šè¡¨ã€‚

æ¯æ¬¡éƒ½è¦è®¿é—®æ•´ä¸ªåˆ—è¡¨å»æŸ¥æ‰¾æˆ‘ä»¬éœ€è¦çš„ç‰©ç†åœ°å€ï¼Œç»ˆå½’è¿˜æ˜¯ä¼šå½±å“æ•ˆç‡ï¼Œæ‰€ä»¥åˆå¼•å…¥äº†**å¤šçº§â»šè¡¨æŠ€æœ¯**ã€‚ä¹Ÿå°±æ˜¯ï¼Œæ ¹æ®ä¸€å®šçš„ç®—æ³•çµæ´»åˆ†é…å¤šçº§â»šè¡¨ï¼Œä¿è¯ä¸€çº§â»šè¡¨æœ€å°çš„å†…å­˜å ç”¨ã€‚å…¶ä¸­ï¼Œ**ä¸€çº§â»šè¡¨å¯¹åº”å¤šä¸ªäºŒçº§â»šè¡¨**ï¼Œå†ç”±**äºŒçº§â»šè¡¨å¯¹åº”è™šæ‹Ÿâ»š**ã€‚

è¿™æ ·å†…å­˜ä¸­åªéœ€è¦ä¿å­˜ä¸€çº§â»šè¡¨å°±å¯ä»¥ï¼Œä¸ä»…å‡å°‘äº†å†…å­˜å ç”¨ï¼Œè€Œä¸”è¿˜æé«˜äº†è®¿é—®æ•ˆç‡ã€‚æ ¹æ®å¤šçº§â»šè¡¨åˆ†é…â»šè¡¨å±‚çº§ç®—æ³•ï¼Œç©ºé—´å ç”¨å¤šæ—¶ï¼Œâ»šè¡¨çº§åˆ«å¢å¤šï¼Œè®¿é—®â»šè¡¨å±‚çº§æ¬¡æ•°ä¹Ÿä¼šå¢å¤šï¼Œæ‰€ä»¥**å¤šçº§â»šè¡¨æœºåˆ¶å±äºå…¸å‹çš„æ”¯æŒæ—¶é—´æ¢ç©ºé—´çš„çµæ´»æ–¹æ¡ˆ**ã€‚

ç”±äºç§»åŠ¨è®¾å¤‡çš„å†…å­˜èµ„æºé™åˆ¶ï¼Œè™šæ‹Ÿåˆ†â»šåœ¨ `iOS` ç³»ç»Ÿä¸­çš„æ§åˆ¶æ–¹å¼æ›´ä¸¥æ ¼ã€‚ç§»åŠ¨è®¾å¤‡çš„ç£ç›˜ç©ºé—´ä¹Ÿä¸å¤Ÿç”¨ï¼Œå› æ­¤æ²¡æœ‰ä½¿ç”¨`DRAM`(åŠ¨æ€ `RAM`)çš„æ–¹å¼æ§åˆ¶å†…å­˜ã€‚ä¸ºäº†å‡å°‘ç£ç›˜ç©ºé—´å ç”¨ï¼Œ`iOS` é‡‡ç”¨äº† `Jetsam` æœºåˆ¶æ¥æ§åˆ¶å†…å­˜çš„ä½¿ç”¨ã€‚
> å¤‡æ³¨:DRAM å†…å­˜æ§åˆ¶æ–¹å¼ï¼Œæ˜¯åœ¨è™šæ‹Ÿâ»šä¸å‘½ä¸­çš„æƒ…å†µä¸‹é‡‡ç”¨ç£ç›˜æ¥ç¼“å­˜ã€‚

å ç”¨å†…å­˜è¿‡å¤šçš„è¿›ç¨‹ä¼šè¢«å¼ºæ€ï¼Œè¿™ä¹Ÿå°±å¯¹ `App` å ç”¨çš„å†…å­˜æå‡ºäº†æ›´é«˜çš„è¦æ±‚ã€‚åŒæ—¶ï¼Œ`Jetsam`æœºåˆ¶ä¹Ÿå¯ä»¥é¿å…ç£ç›˜å’Œå†…å­˜äº¤æ¢ å¸¦æ¥çš„æ•ˆç‡é—®é¢˜ï¼Œå› ä¸ºç£ç›˜çš„é€Ÿåº¦è¦æ¯” `DRAM` æ…¢ä¸Šå‡ ä¸‡å€ã€‚

>  `Jetsam`æœºåˆ¶:
`iOS` æ˜¯ä¸€ä¸ªä» `BSD` è¡ç”Ÿè€Œæ¥çš„ç³»ç»Ÿï¼Œå…¶å†…æ ¸æ˜¯ `Mach`ã€‚å…¶ä¸­å†…å­˜è­¦å‘Šï¼Œä»¥åŠ `OOM` å´©æºƒçš„å¤„ç†æœºåˆ¶å°±æ˜¯ `Jetsam` æœºåˆ¶ï¼Œä¹Ÿè¢«ç§°ä¸º `Memorystatus`ã€‚`Jetsam` ä¼šå§‹ç»ˆç›‘æ§å†…å­˜æ•´ä½“ä½¿ç”¨æƒ…å†µï¼Œå½“å†…å­˜ä¸è¶³æ—¶ä¼šæ ¹æ®ä¼˜å…ˆçº§ã€å†…å­˜å ç”¨å¤§å°æ€æ‰ä¸€äº›è¿›ç¨‹ï¼Œå¹¶è®°å½•æˆ `JetsamEvent`ã€‚(ä½å†…å­˜ç®¡ç†æœºåˆ¶`Jetsam`ï¼Œæ˜¯ä¸€ä¸ªåŸºäºä¼˜å…ˆçº§é˜Ÿåˆ—çš„æœºåˆ¶)

* [iOS appå†…å­˜åˆ†æå¥—è·¯](https://www.cnblogs.com/BigFeng/p/6178301.html)
* [Appleå®˜æ–¹:æœ€å¤§æ„å»ºç‰ˆæœ¬æ–‡ä»¶å¤§å°](https://help.apple.com/app-store-connect/#/dev611e0a21f)
* [iOSå†…å­˜abort(Jetsam) åŸç†æ¢ç©¶](https://satanwoo.github.io/2017/10/18/abort/)
* [XNU Jetsam Code](https://opensource.apple.com/source/xnu/jetsam_kill_cause_name-3789.70.16/bsd/kern/kern_memorystatus.c.auto.html)
